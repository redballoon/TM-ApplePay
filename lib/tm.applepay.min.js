/**
* tm.applepay
*
* A light robust javascript wrapper for the Apple Pay for Web API.
*
* @version v1.0.0
* @author Fredi Quirino
*/
!function(e){"use strict";var t=function(e){var n,i,o={debug:!1,namespace:"applepay",merchantId:"",displayName:"",endpoint:{session:"",payment:""},paymentDefault:{countryCode:"",currencyCode:"",total:{label:"",amount:0},supportedNetworks:["amex","discover","masterCard","visa"],merchantCapabilities:["supports3DS"],shippingMethods:[],lineItems:[]},filters:{},sessionTimeout:24e4},a={init:!1},l={id:null,instance:null,$instance:null,request:null,currentShippingMethod:null,timeout:null,counter:0},r={log:function(){var e=console;n.debug&&("undefined"!=typeof n.logger&&(e=n.logger),Array.prototype.splice.call(arguments,0,0,n.namespace),e.log.apply(e,arguments))},events:function(e,t){i.trigger(e+"."+n.namespace,t)},rando:function(e,t){return Math.random()*(t-e)+e},error:function(e,t,n,i){var o={error:{}};!l.instance||null===e&&null===t&&null===n||l.instance.abort(),l.id=null,l.instance=null,l.$instance=null,l.request=null,l.currentShippingMethod=null,null!==l.timeout&&(clearTimeout(l.timeout),l.timeout=null),"function"==typeof i&&(null!==e&&(o.error.code=e),null===e&&null===t&&null!==n?o.error=n:null!==t?o.error.message=t:null!==n&&(o.error.message=n),i(o))},fail:function(e,t){r.error(null,null,e,t)},normalizeAmount:function(e){var t="number"==typeof e?e:parseFloat(e);return t=isNaN(t)?0:t,t=t<0?0:t},request:function(t,n,i){r.log("request:",t,n);var o=e.extend({},{method:"POST",dataType:"json"},n);e.ajax(o).always(function(e,n,o){return r.log("request: request complete:",t,e),l.instance&&l.id===t?("success"===n&&e||(r.log("request: request failed:",n),e=!1),void("function"==typeof i&&i(e))):void r.log("request: invalid session.")})}};return{getTotal:function(){if(!l.id)return r.log("getTotal: invalid session."),!1;var t=l.request.total;if(n.trackLineItems){var i=0;e.each(l.lineItems,function(){"undefined"!=typeof this.amount&&(i+=this.amount)}),l.request.total.amount=r.normalizeAmount(i.toFixed(2))}return t},getLineItems:function(){if(!l.id)return r.log("getLineItems: invalid session."),!1;var t=l.request.lineItems;return n.trackLineItems&&(t=[],e.each(l.lineItems,function(e,n){"undefined"!=typeof this.amount&&t.push(this)})),t},getSelectedShippingMethod:function(){return l.id?l.currentShippingMethod:(r.log("getSelectedShippingMethod: invalid session."),!1)},updateTotal:function(e){return l.instance?"string"!=typeof e.label?(r.log("updateTotal: invalid value for label.",e),!1):"string"!=typeof e.amount&&"number"!=typeof e.amount?(r.log("updateTotal: invalid value for amount.",e),!1):(e.amount=r.normalizeAmount(e.amount),l.request.total=e,!0):(r.log("updateTotal: invalid session."),!1)},updateLineItems:function(t){return l.instance?e.isArray(t)?(e.each(t,function(){this.amount=r.normalizeAmount(this.amount)}),l.request.lineItems=t,!0):(r.log("updateLineItems: invalid value for lineItems."),!1):(r.log("updateLineItems: invalid session."),!1)},updateShippingMethods:function(e){return r.log("updateShippingMethods:",e),l.instance?(l.request.shippingMethods=e,l.currentShippingMethod=null,!n.trackLineItems||(l.lineItems.shipping.type="pending",l.lineItems.shipping.amount=0,!0)):(r.log("updateShippingMethods: invalid session."),!1)},updateSelectedShippingMethod:function(e){return r.log("updateSelectedShippingMethod:",e),l.instance?(l.currentShippingMethod=e,l.currentShippingMethod.amount=r.normalizeAmount(l.currentShippingMethod.amount),!n.trackLineItems||(l.lineItems.shipping.type="final",l.lineItems.shipping.amount=l.currentShippingMethod.amount,r.log("updateSelectedShippingMethod:",l.currentShippingMethod.amount),!0)):(r.log("updateSelectedShippingMethod: invalid session."),!1)},updateDiscount:function(e){return l.instance?n.trackLineItems?!e||"number"!=typeof e||isNaN(e)?(r.log("updateDiscount: invalid argument."),!1):(l.lineItems.discounts.type="final",l.lineItems.discounts.amount=e,"undefined"==typeof l.lineItems.discounts.label&&(l.lineItems.discounts.label="Discount"),r.log("updateDiscount:",e),!0):(r.log("updateDiscount: line items are not being tracked."),!1):(r.log("updateDiscount: invalid session."),!1)},updateTaxes:function(e){return l.instance?n.trackLineItems?!e||"number"!=typeof e||isNaN(e)?(r.log("updateTaxes: invalid argument."),!1):(l.lineItems.taxes.type="final",l.lineItems.taxes.amount=e,"undefined"==typeof l.lineItems.taxes.label&&(l.lineItems.taxes.label="Tax"),r.log("updateTaxes:",e),!0):(r.log("updateTaxes: line items are not being tracked."),!1):(r.log("updateTaxes: invalid session."),!1)},complete:function(e,t){if(r.log("complete:",e,t),!l.instance)return r.log("complete: invalid session."),!1;var n=this,i=!1,o=Array.prototype.splice.call(arguments,2);switch(e){case"shippingMethodSelection":case"completeShippingMethodSelection":e="completeShippingMethodSelection",o.length?Array.prototype.splice.call(o,0,0,t):Array.prototype.splice.call(o,0,0,t,n.getTotal(),n.getLineItems());break;case"shippingContactSelection":case"completeShippingContactSelection":e="completeShippingContactSelection",o.length?Array.prototype.splice.call(o,0,0,t):o.splice(0,0,t,l.request.shippingMethods,n.getTotal(),n.getLineItems());break;case"paymentMethodSelection":case"completePaymentMethodSelection":e="completePaymentMethodSelection",o.length?Array.prototype.splice.call(o,0,0,t):Array.prototype.splice.call(o,0,0,n.getTotal(),n.getLineItems());break;default:r.log("complete: invalid method argument."),i=!0}if(i)return r.fail(!1,null),!1;r.log("complete: arguments",o);try{l.instance[e].apply(l.instance,o)}catch(e){return r.log("complete: an error occured.",e),r.fail(!1,null),!1}return!0},createSession:function(t,i){var o=this;if(l.request=e.extend({},n.paymentDefault,t),!l.request.countryCode)return r.log("createSession: invalid value for country code."),void r.error(0,"invalid arguments.",null,i);if(!l.request.currencyCode)return r.log("createSession: invalid value for currency code."),void r.error(0,"invalid arguments.",null,i);if(!l.request.total.label)return r.log("createSession: invalid value for label."),void r.error(0,"invalid arguments.",null,i);if(l.request.total.amount="string"==typeof l.request.total.amount?parseFloat(l.request.total.amount):l.request.total.amount,"number"!=typeof l.request.total.amount||isNaN(l.request.total.amount)||l.request.total.amount<0)return r.log("createSession: invalid value for amount."),void r.error(0,"invalid arguments.",null,i);l.request.total.amount=l.request.total.amount.toFixed(2),r.log("createSession: log request object",l.request),l.id=Math.ceil(r.rando(1,1e3))+"-"+e.now()+l.counter,l.counter++,l.currentShippingMethod=l.request.shippingMethods.length?l.request.shippingMethods[0]:null,n.trackLineItems=!1,l.request.trackLineItems&&"undefined"!=typeof l.request.customLineItems&&(n.trackLineItems=!0,l.lineItems=l.request.customLineItems),"undefined"!=typeof l.request.trackLineItems&&delete l.request.trackLineItems,"undefined"!=typeof l.request.customLineItems&&delete l.request.customLineItems,n.trackLineItems&&!l.request.lineItems.length&&(l.request.lineItems=o.getLineItems());try{l.instance=new window.ApplePaySession(1,l.request),l.$instance=e(l.instance)}catch(e){return r.log("createSession: an error occured: 1002.",e),void r.error(1002,null,e,i)}e(window).one("unload",function(){r.fail(!1,null)}),l.$instance.on("validatemerchant",function(e){r.log("event: validatemerchant:",e);var t={url:n.endpoint.session,data:{validationURL:e.originalEvent.validationURL,domainName:window.location.hostname,displayName:n.displayName}};r.request(l.id,t,function(e){if(!e)return void r.error(2002,"validation failed.",null,i);try{l.instance.completeMerchantValidation(e)}catch(e){return void r.log("createSession: an error occured: 1006.",e)}l.timeout=setTimeout(function(){r.log("createSession: session expired."),l.timeout=null,r.fail(!1,null)},n.sessionTimeout)})}).on("shippingmethodselected",function(e){r.log("event: shippingmethodselected:",e),o.updateSelectedShippingMethod(e.originalEvent.shippingMethod)}).on("cancel",function(e){r.log("event: cancel:",e),r.fail(null,null)}).on("paymentauthorized",function(e){r.log("event: paymentauthorized:",e),null!==l.timeout&&(clearTimeout(l.timeout),l.timeout=null);var t,o=e.originalEvent.payment;t={url:n.endpoint.payment,data:o},r.request(l.id,t,function(e){var t;t=e?window.ApplePaySession.STATUS_SUCCESS:window.ApplePaySession.STATUS_FAILURE;try{l.instance.completePayment(t)}catch(e){return r.log("createSession: an error occured: 1010.",e),void r.error(1010,null,e,i)}})});try{l.instance.begin()}catch(e){return r.log("createSession: an error occured: 1004.",e),void r.error(1004,null,e,i)}return l.instance},close:function(){return l.instance?void r.fail(!1,null):(r.log("close: invalid session."),!1)},available:function(e){r.log("available: will check availability."),window.ApplePaySession.canMakePayments()||(r.log("available: Apple Pay is not available."),r.fail(!1,e)),window.ApplePaySession.canMakePaymentsWithActiveCard(n.merchantId).then(function(t){r.log("available: request complete.",t),"function"==typeof e&&e(t)})},init:function(l){return l=l?l:{},a.init?(r.log("init: already initiated."),t):window.ApplePaySession?"undefined"==typeof window.jQuery?(l.debug&&console.log("init: jQuery is required."),!1):l.merchantId&&"string"==typeof l.merchantId?(n=e.extend({},o,l),i=e("body"),i.length?(a.init=!0,t):(r.log("init: el element not found."),!1)):(l.debug&&console.log("init: invalid merchant ID argument."),!1):(l.debug&&console.log("init: ApplePaySession is not available."),!1)}}}(jQuery);e.applePay=function(e){return t.init(e)}}(window.tm||(window.tm={}));